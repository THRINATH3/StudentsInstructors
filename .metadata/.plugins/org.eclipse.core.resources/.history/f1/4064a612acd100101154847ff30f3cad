package com.example.studentCourses.serviceLayer;

import java.time.LocalDateTime;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.example.studentCourses.Entity.RegisteredStudentsEntity;
import com.example.studentCourses.dtos.LoginResponse;
import com.example.studentCourses.dtos.StudentLoginRequest;
import com.example.studentCourses.dtos.StudentResponse;
import com.example.studentCourses.exceptions.AuthenticationFailedException;
import com.example.studentCourses.exceptions.ResourceNotFoundException;
import com.example.studentCourses.repository.RegisteredStudentsRepository;
import com.example.studentCourses.security.JwtUtil;

@Service
public class RegisteredStudentsService {

    @Autowired
    private RegisteredStudentsRepository registeredStudentsRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private JwtUtil jwtUtil;

    public StudentResponse getStudent(Long id) {
    	RegisteredStudentsEntity student = registeredStudentsRepository.findById(id).orElseThrow(() -> new RuntimeException("Student not found"));
    	return convertToResponse(student);
    }
    
    // REGISTER STUDENT 
    public StudentResponse registerStudent(RegisteredStudentsEntity student) {

        // Hash password
        String hashedPassword = passwordEncoder.encode(student.getSPassword());
        student.setSPassword(hashedPassword);
        student.setCreatedAt(LocalDateTime.now());
        student.setUpdatedAt(LocalDateTime.now());

        // Save to DB
        RegisteredStudentsEntity saved = registeredStudentsRepository.save(student);

        // Convert Entity -> DTO
        return convertToResponse(saved);
    }

    // LOGIN STUDENT 
    public LoginResponse loginStudent(StudentLoginRequest studentRequest) {

        // Find by email
        RegisteredStudentsEntity storedStudent =
                registeredStudentsRepository.findBysEmail(studentRequest.getSEmail());

        if (storedStudent == null) {
            throw new ResourceNotFoundException("No student found with email: " + studentRequest.getSEmail());
        }

        // Check password
        boolean passwordMatch = passwordEncoder.matches(
                studentRequest.getSPassword(),
                storedStudent.getSPassword()
        );

        if (!passwordMatch) {
            throw new AuthenticationFailedException("Incorrect password");
        }

        // Convert Entity -> DTO
        String token = jwtUtil.generateToken(
                storedStudent.getSId(),
                storedStudent.getSFirstName(),
                storedStudent.getSLastName(),
                storedStudent.getSEmail(),
                storedStudent.getCreatedAt(),
                storedStudent.getUpdatedAt(),
                null,                   
                "STUDENT"
        );
        
        return new LoginResponse(token);
    }

    // ENTITY -> DTO CONVERTER 
    private StudentResponse convertToResponse(RegisteredStudentsEntity student) {
        StudentResponse response = new StudentResponse();
        response.setId(student.getSId());
        response.setFirstName(student.getSFirstName());
        response.setLastName(student.getSLastName());
        response.setEmail(student.getSEmail());
        response.setCreatedAt(student.getCreatedAt());
        response.setUpdatedAt(student.getUpdatedAt());
        return response;
    }
}
