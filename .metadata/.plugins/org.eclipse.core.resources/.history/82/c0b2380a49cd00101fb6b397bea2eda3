package com.example.studentCourses.serviceLayer;

import java.time.LocalDateTime;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.example.studentCourses.Entity.RegisteredStudentsEntity;
import com.example.studentCourses.dtos.StudentLoginRequest;
import com.example.studentCourses.dtos.StudentResponse;
import com.example.studentCourses.repository.RegisteredStudentsRepository;

@Service
public class RegisteredStudentsService {

    @Autowired
    private RegisteredStudentsRepository registeredStudentsRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    // Register student
    public RegisteredStudentsEntity registerStudent(RegisteredStudentsEntity student) {

        String hashedPassword = passwordEncoder.encode(student.getsPassword());
        student.setsPassword(hashedPassword);
        student.setCreatedAt(LocalDateTime.now());
        student.setUpdatedAt(LocalDateTime.now());

        return registeredStudentsRepository.save(student);
    }

    // Login Student → returns DTO
    public StudentResponse loginStudent(StudentLoginRequest student) {

        RegisteredStudentsEntity storedStudent =
                registeredStudentsRepository.findBySEmail(student.getEmail());

        if (storedStudent == null) {
            return null; // email not found
        }

        boolean passwordMatch =
                passwordEncoder.matches(student.getPassword(), storedStudent.getsPassword());

        if (!passwordMatch) {
            return null; // password wrong
        }

        // Convert entity → DTO
        StudentResponse response = new StudentResponse();
        response.setId(storedStudent.getId());
        response.setFirstName(storedStudent.getsFirstName());
        response.setLastName(storedStudent.getsLastName());
        response.setEmail(storedStudent.getsEmail());
        response.setCreatedAt(storedStudent.getCreatedAt());
        response.setUpdatedAt(storedStudent.getUpdatedAt());

        return response;
    }
}
