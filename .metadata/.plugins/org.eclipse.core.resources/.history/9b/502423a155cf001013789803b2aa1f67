package com.example.studentCourses.serviceLayer;

import java.time.LocalDateTime;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.example.studentCourses.Entity.RegisteredInstructorsEntity;
import com.example.studentCourses.dtos.InstructorLoginRequest;
import com.example.studentCourses.dtos.InstructorResponse;
import com.example.studentCourses.dtos.LoginResponse;
import com.example.studentCourses.exceptions.AuthenticationFailedException;
import com.example.studentCourses.exceptions.ResourceNotFoundException;
import com.example.studentCourses.repository.RegisteredInstructorsRespository;
import com.example.studentCourses.security.JwtUtil;

@Service
public class RegisteredInstructorsService {

    @Autowired
    private RegisteredInstructorsRespository registeredInstructorsRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private JwtUtil jwtUtil;

    // REGISTER INSTRUCTOR 
    public InstructorResponse registerInstructor(RegisteredInstructorsEntity instructor) {

        // Hash password
        String hashedPassword = passwordEncoder.encode(instructor.getiPassword());
        instructor.setiPassword(hashedPassword);

        instructor.setiCreatedAt(LocalDateTime.now());
        instructor.setiUpdatedAt(LocalDateTime.now());

        // Save to DB
        RegisteredInstructorsEntity saved = registeredInstructorsRepository.save(instructor);

        // Convert Entity -> DTO
        return convertToResponse(saved);
    }

    // LOGIN INSTRUCTOR
    public LoginResponse loginInstructor(InstructorLoginRequest req) {

        // Find instructor by email
        RegisteredInstructorsEntity storedInstructor =
                registeredInstructorsRepository.findByIEmail(req.getEmail());

        if (storedInstructor == null) {
            throw new ResourceNotFoundException("Instructor not found with email: " + req.getEmail());
        }

        // Validate password
        boolean passwordMatch = passwordEncoder.matches(
                req.getPassword(),
                storedInstructor.getiPassword()
        );

        if (!passwordMatch) {
            throw new AuthenticationFailedException("Incorrect password");
        }
        
        String token = jwtUtil.generateToken(
                storedInstructor.getiId(),
                storedInstructor.getiFirstName(),
                storedInstructor.getiLastName(),
                storedInstructor.getiEmail(),
                storedInstructor.getiCreatedAt(),
                storedInstructor.getiUpdatedAt(),
                storedInstructor.getiBio(),
                "INSTRUCTOR"
        );

        return new LoginResponse(token);
    }

    // ENTITY -> DTO CONVERTER
    private InstructorResponse convertToResponse(RegisteredInstructorsEntity instructor) {
        InstructorResponse response = new InstructorResponse();

        response.setId(instructor.getiId());
        response.setFirstName(instructor.getiFirstName());
        response.setLastName(instructor.getiLastName());
        response.setEmail(instructor.getiEmail());
        response.setBio(instructor.getiBio());
        response.setCreatedAt(instructor.getiCreatedAt());
        response.setUpdatedAt(instructor.getiUpdatedAt());

        return response;
    }
}
